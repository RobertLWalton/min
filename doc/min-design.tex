% Minimal Descriptive Programming Language Design
%
% File:         min-design.tex
% Author:       Bob Walton (walton@deas.harvard.edu)
% Date:		See \date below.
  
\documentclass[12pt]{article}

\usepackage{makeidx}
\usepackage{pictex}

\makeindex

\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\textwidth}{6.5in}
\raggedbottom

\setlength{\unitlength}{1in}

\pagestyle{headings}
\setlength{\parindent}{0.0in}
\setlength{\parskip}{1ex}

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}
\newcommand{\subsubsubsection}[1]{\paragraph[#1]{#1.}}
\newcommand{\subsubsubsubsection}[1]{\subparagraph[#1]{#1.}}

% Begin \tableofcontents surgery.

\newcount\AtCatcode
\AtCatcode=\catcode`@
\catcode `@=11	% @ is now a letter

\renewcommand{\contentsname}{}
\renewcommand\l@section{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\l@table{\@dottedtocline{1}{0.1em}{1.4em}}
\renewcommand\tableofcontents{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{1.0in}%
	      \setlength{\rightmargin}{1.0in}}%
    \item\@starttoc{toc}%
    \end{list}}
\renewcommand\listoftables{%
    \begin{list}{}%
	     {\setlength{\itemsep}{0in}%
	      \setlength{\topsep}{0in}%
	      \setlength{\parsep}{1ex}%
	      \setlength{\labelwidth}{0in}%
	      \setlength{\baselineskip}{1.5ex}%
	      \setlength{\leftmargin}{1.0in}%
	      \setlength{\rightmargin}{1.0in}%
	      }%
    \item\@starttoc{lot}%
    \end{list}}

\catcode `@=\AtCatcode	% @ is now restored

% End \tableofcontents surgery.

\newcommand{\CN}[2]%	Change Notice.
    {\hspace*{0in}\marginpar{\sloppy \raggedright \it \footnotesize
     $^{\mbox{#1}}$#2}}
    % Change notice.

\newcommand{\key}[1]{{\em #1}\index{#1}}
\newcommand{\mkey}[2]{{\em #1}\index{#1!#2}}
\newcommand{\skey}[2]{{\em #1#2}\index{#1}}
\newcommand{\ikey}[2]{{\em #1}\index{#2}}
\newcommand{\ttkey}[1]{{\tt #1}\index{#1@{\tt #1}}}
\newcommand{\ttmkey}[2]{{\tt #1}\index{#1@{\tt #1}!#2}}
\newcommand{\ttfkey}[2]{{\tt #1}\index{#1@{\tt #1}!for #2@for {\tt #2}}}
\newcommand{\ttakey}[2]{{\tt #1}\index{#2@{\tt #1}}}
\newcommand{\ttamkey}[3]{{\tt #1}\index{#2@{\tt #1}!#3}}
\newcommand{\ttindex}[1]{\index{#1@{\tt #1}}}
\newcommand{\ttmindex}[2]{\index{#1@{\tt #1}!#2}}
\newcommand{\emkey}[1]{{\em #1}\index{#1@{\em #1}}}
\newcommand{\emindex}[1]{\index{#1@{\em #1}}}

\newcommand{\minkey}[1]{{\tt min::#1}\ttindex{min::#1}\ttindex{#1}}
\newcommand{\mupkey}[1]{{\tt mup::#1}\ttindex{mup::#1}\ttindex{#1}}
\newcommand{\minindex}[1]{\ttindex{min::#1}\ttindex{#1}}
\newcommand{\mupindex}[1]{\ttindex{mup::#1}\ttindex{#1}}


\newcommand{\secref}[1]{\ref{#1}\,p\pageref{#1}}
\newcommand{\stepref}[1]{\ref{#1}\,p\pageref{#1}}
\newcommand{\appref}[1]{\ref{#1}\,p\pageref{#1}}
\newcommand{\pagref}[1]{p\pageref{#1}}

\newcommand{\EOL}{\penalty \exhyphenpenalty}

\newcount\TildeCatcode
\TildeCatcode=\catcode`\~
\catcode`~=12
\newcommand{\Tilde}{~}
\catcode`~=\TildeCatcode

\newcount\CircumflexCatcode
\CircumflexCatcode=\catcode`\^
\catcode`^=12
\newcommand{\Circumflex}{^}
\catcode`^=\CircumflexCatcode

\newcount\CurlyBraCatcode
\newcount\CurlyKetCatcode
\newcount\SquareBraCatcode
\newcount\SquareKetCatcode
\CurlyBraCatcode=\catcode`{
\CurlyKetCatcode=\catcode`}
\SquareBraCatcode=\catcode`[
\SquareKetCatcode=\catcode`]

\catcode`{=\SquareBraCatcode
\catcode`}=\SquareKetCatcode
\catcode`[=\CurlyBraCatcode
\catcode`]=\CurlyKetCatcode

\newcommand[\CurlyBra][{]
\newcommand[\CurlyKet][}]

\catcode`{=\CurlyBraCatcode
\catcode`}=\CurlyKetCatcode
\catcode`[=\SquareBraCatcode
\catcode`]=\SquareKetCatcode

\newcommand{\ttbrackets}{%
    \renewcommand{\{}{\CurlyBra}%
    \renewcommand{\}}{\CurlyKet}}

\newsavebox{\TILDEBOX}
\begin{lrbox}{\TILDEBOX}
\verb|~|
\end{lrbox}
\newcommand{\TILDE}{\usebox{\TILDEBOX}}

\newsavebox{\BACKSLASHBOX}
\begin{lrbox}{\BACKSLASHBOX}
\verb|\|
\end{lrbox}
\newcommand{\BACKSLASH}{\usebox{\BACKSLASHBOX}}

\newsavebox{\LEFTBRACKETBOX}
\begin{lrbox}{\LEFTBRACKETBOX}
\verb|{|
\end{lrbox}
\newcommand{\LEFTBRACKET}{\usebox{\LEFTBRACKETBOX}}

\newsavebox{\RIGHTBRACKETBOX}
\begin{lrbox}{\RIGHTBRACKETBOX}
\verb|}|
\end{lrbox}
\newcommand{\RIGHTBRACKET}{\usebox{\RIGHTBRACKETBOX}}

\newsavebox{\UNDERLINEBOX}
\begin{lrbox}{\UNDERLINEBOX}
\verb|_|
\end{lrbox}
\newcommand{\UNDERLINE}{\usebox{\UNDERLINEBOX}}

\newsavebox{\CIRCUMFLEXBOX}
\begin{lrbox}{\CIRCUMFLEXBOX}
\verb|^|
\end{lrbox}
\newcommand{\CIRCUMFLEX}{\usebox{\CIRCUMFLEXBOX}}

\newsavebox{\BARBOX}
\begin{lrbox}{\BARBOX}
\verb/|/
\end{lrbox}
\newcommand{\BAR}{\usebox{\BARBOX}}

\newsavebox{\LESSTHANBOX}
\begin{lrbox}{\LESSTHANBOX}
\verb/</
\end{lrbox}
\newcommand{\LESSTHAN}{\usebox{\LESSTHANBOX}}

\newsavebox{\GREATERTHANBOX}
\begin{lrbox}{\GREATERTHANBOX}
\verb/>/
\end{lrbox}
\newcommand{\GREATERTHAN}{\usebox{\GREATERTHANBOX}}

\newlength{\figurewidth}
\setlength{\figurewidth}{\textwidth}
\addtolength{\figurewidth}{-0.40in}

\newsavebox{\figurebox}

\newenvironment{boxedfigure}[1][!btp]%
	{\begin{figure*}[#1]
	 \begin{lrbox}{\figurebox}
	 \begin{minipage}{\figurewidth}

	 \vspace*{1ex}}%
	{
	 \vspace*{1ex}

	 \end{minipage}
	 \end{lrbox}
	 \begin{center}
	 \fbox{\hspace*{0.1in}\usebox{\figurebox}\hspace*{0.1in}}
	 \end{center}
	 \end{figure*}}

\newenvironment{indpar}[1][0.3in]%
	{\begin{list}{}%
		     {\setlength{\itemsep}{0in}%
		      \setlength{\topsep}{0in}%
		      \setlength{\parsep}{1ex}%
		      \setlength{\labelwidth}{#1}%
		      \setlength{\leftmargin}{#1}%
		      \addtolength{\leftmargin}{\labelsep}}%
	 \item}%
	{\end{list}}

\begin{document}
        
\title{Design\\[2ex]of the\\[2ex]
       Minimal\\Descriptive Programming\\Language\\[2ex]MIN\\[2ex]
       (Draft 1a)}

\author{Robert L. Walton}

\date{September 16, 2004}
 
\maketitle

\newpage
\begin{center}
\large \bf Table of Contents
\end{center}

\bigskip

\tableofcontents 

\newpage

\section{Introduction}

This document describes the internal design of MIN,
the Minimal Descriptive Programming Language.
This document is written for readers who which to add C++ code
to a MIN implementation, or who wish to maintain an implementation.


\section{Data}

We first describe MIN data memory.

We give two interfaces to MIN data memory:
the \key{protected interface}, which can be used
by C++ code to access MIN data memory while maintaining the integrity
of that memory, and the \key{unprotected interface}, which provides
more efficient access to MIN data memory but requires the user to
follow certain protocols.

From the syntactic point of view the
only distinction between these interfaces is that code that
uses the unprotected interface must

\begin{center}
\verb|#include  <min_unprotected.h>|
\end{center}

and all unprotected
interface names begin with `\minkey{unprotected::}'.  Code
that uses the unprotected interface typically abbreviates this long
name prefix to `\ttmkey{mup::}{abbreviates {\tt min::unprotected::}}'
by including after the `\verb|#include|' statement above the definition:

\begin{center}
\verb|#define  mup  min::unprotected|
\end{center}

In this document we will use the abbreviation `\verb|mup|' for
`\verb|min::unprotected|'.

The data of MIN is defined using C-compatible \ttmkey{struct}{C compatible}'s
and \ttmkey{union}{C compatible}'s.  C++ implicitly guarentees the layout of
C-compatible \verb|struct|'s and \verb|union|'s to be C-compatible,
and C has implicit guarentees because of historical C code that
such data will not contain unnecessary unnamed padding.  Neither the
C or C++ standards guarentee the absence of unnecessary unnamed padding, but
MIN depends upon its absence.

As a consequence of using only C-compatible \verb|struct|'s and
\verb|union|'s to define data, MIN does not use member functions,
and uses overloaded functions instead.  Protected functions
have names beginning with `\ttmkey{min::}{in function name}'
only if they have no argument that is a pointer to a MIN defined
datum.  Most protected MIN functions have such pointer arguments
and have overloaded names that do not begin with any class qualifier.
Unprotected MIN functions have names beginning with 
`\ttmkey{mup::}{in function name}'.

In defining MIN data the following number types are used to be sure
the size of each number is clear:

\begin{center}
\begin{tabular}{l@{~~~~~}l}
\minkey{uns8}	& unsigned 8-bit integer \\
\minkey{int8}	& signed 8-bit integer \\
\minkey{uns16}	& unsigned 16-bit integer \\
\minkey{int16}	& signed 16-bit integer \\
\minkey{uns32}	& unsigned 32-bit integer \\
\minkey{int32}	& signed 32-bit integer \\
\minkey{float32}	& 32-bit IEEE floating point number \\
\minkey{uns64}	& unsigned 64-bit integer \\
\minkey{int64}	& signed 64-bit integer \\
\minkey{float64}	& 64-bit IEEE floating point number \\
\end{tabular}
\end{center}%
\label{MIN::UNS8}%
\label{MIN::INT8}%
\label{MIN::UNS16}%
\label{MIN::INT16}%
\label{MIN::UNS32}%
\label{MIN::INT32}%
\label{MIN::FLOAT32}%
\label{MIN::UNS64}%
\label{MIN::INT64}%
\label{MIN::FLOAT64}

\subsection{Stubs and Bodies}

MIN data memory consists of regions that contain stubs and regions
that contain bodies.  A region is a continguous multi-page block
of memory.

\ikey{Stubs}{stub}
are small fixed size units of memory that cannot be relocated:
the usual stub size for MIN is 16 bytes.
Each object has a stub, and the address of the stub is in effect
the internal name of the object.  Some or all atoms, depending
on implementation, have stubs.

A stub is divided into an 8 byte value and an 8 byte control.
The \mkey{value}{of stub} can hold an IEEE floating point number,
an 8 character string, or, as we will soon see, a pointer to a body.
It is also possible, though not common, for a value to hold any other
8 bytes of information.

The control holds a 1 byte type code and other information used,
for example, by the garbage collector.

A \key{body} is a variable sized relocatable block of memory
attached to a particular stub.  A stub may have one body attached to
it, in which case the stub value is a pointer to that body.
At almost any time the body can be moved and the stub value reset to
point at the new location of the body.  The body may be deallocated by
moving it to unimplemented memory.  Bodies are always some multiple
of 8 bytes long, and are allocated on 8 byte boundaries.

Protected functions that take a stub pointer as argument use
\ttmkey{assert}{in protected function} statements to check
the type code of the stub and various lengths.  Unprotected functions
contain no such checks.

Memory consisting of unrelocatable stubs pointing at relocatable
bodies is called a `\key{stub/body memory}'.  Thus MIN has a stub/body memory.

The type name of a stub is `\minkey{stub}', and a pointer to a stub
has type `\verb|min::stub *|'.\label{MIN::STUB}


\subsection{General Values}
\label{GENERAL-VALUES}

A general value can store any of:

\begin{center}
\begin{tabular}{l}
an atom or pointer to an atom \\
a pointer to a stub \\
an indirect pointer
\end{tabular}
\end{center}

General values are used to designate attribute names and values in
objects.

It does not matter whether a general value stores an atom or a pointer
to the atom, so atoms are immutable and cannot be changed.

An indirect pointer is an integer that is used by a general value
inside an object body to point at another general value inside the
body.  See~\secref{INDIRECT-POINTERS}.

There are two kinds of MIN implementation: `\key{compact}' and
`\key{loose}'.
A compact implementation uses only 32-bit
general values, and uses \underline{no} 64-bit general values.
A loose implementation uses only 64-bit
general values, and uses \underline{no} 32-bit general values.

The value of a compact implementation is that it uses less memory,
but there may be speed penalty (see \secref{32-BIT-GENERAL-VALUES}).
The value of a loose implementation is that it may run faster, but
there is a memory penalty.  It is not clear what the speed difference
between the two implementations really is, so both implementations
are offered in order to decide the issue by experiment.

\subsubsection{32-Bit General Values}
\label{32-BIT-GENERAL-VALUES}

A \key{32-bit general value} has type \minkey{gen32} and
is a 32 bit aligned value that can hold a value of one of the following
subtypes

\begin{center}
\begin{tabular}{l}
a pointer to a stub \\
a 28-bit integer atom \\
an 28-bit indirect pointer 
\end{tabular}
\end{center}


On machines that have 32 bit addresses (e.g.,
the IA32\footnote{Intel Architecture 32-bit} machines), stub addresses
stored in {\tt min::gen32} values are implemented as addresses of stubs.
On other machines that may use addresses longer than 32-bits, 
stub addresses are stored in {\tt min::gen32} values as
`\skey{virtual stub number}s', or \skey{VSN}{'s}, that map to stub addresses.
A VSN is typically mapped to a stub address by shifting it left by 4
bits\footnote{
Stubs are always a power of two in length, e.g. 16 bytes, so VSN's can be
translated to addresses by shifting left.} and adding a base constant.
One effect of using VSN's
instead of addresses is to multiply by 16 the number of
stubs that may exist in memory without needing to use more than 32 bits
to hold the stub address.

A {\tt min::gen32} integer value consists of a high order 4 bit subtype
code and a low order 28 bit integer stored in offset form, so the true
integer can be derived from the {\tt min:gen32} value by subtracting the
{\tt min:gen32} representation of zero.  Similarly indirect pointers
consist of a high order 4 bit subtype code and a low order 28 bit indirect
pointer (see~\secref{INDIRECT-POINTERS}).

The type of a general value is \minkey{gen32}.  This type has the alignment
properties of {\tt min::uns32}, and in some implementations
is {\tt typedef}'ed to {\tt min::uns32}, and so {\tt min::\EOL gen32}
arguments cannot be used to identify overloaded functions.

The following functions return {\tt 1} if a {\tt min::gen32} datum is of the
indicated subtype and {\tt 0} otherwise:

\begin{center}\begin{tabular}{r@{}l}
\verb|int min::| & \verb|is_int ( min::gen32 v )|
\label{MIN::IS_INT_OF_GEN32} \\
\verb|int min::| & \verb|is_indirect ( min::gen32 v )|
\label{MIN::IS_INDIRECT_OF_GEN32} \\
\verb|int min::| & \verb|is_stub ( min::gen32 v )|
\label{MIN::IS_STUB_OF_GEN32} \\
\end{tabular}\end{center}%
\minindex{is\_int}%
\minindex{is\_indirect}%
\minindex{is\_stub}

The following protected functions return the value appropriate for a given
subtype, after checking the subtype code with an {\tt assert} statement:

\begin{center}\begin{tabular}{r@{}l}
\verb|int min::| & \verb|int_of ( min::gen32 v )|
\label{MIN::INT_OF_GEN32} \\
\verb|min::stub * min::| & \verb|stub_of ( min::gen32 v )|
\label{MIN::STUB_OF_GEN32} \\
\verb|unsigned min::| & \verb|indirect_of ( min::gen32 v )|
\label{MIN::INDIRECT_OF_GEN32} \\
\end{tabular}\end{center}%
\minindex{int\_of}%
\minindex{stub\_of}%
\minindex{indirect\_of}

The following unprotected functions return the value appropriate for a given
subtype, \underline{without} checking the subtype code:

\begin{center}\begin{tabular}{r@{}l}
\verb|int mup::| & \verb|int_of ( min::gen32 v )|
\label{MUP::INT_OF_GEN32} \\
\verb|min::stub *  mup::| & \verb|stub_of ( min::gen32 v )|
\label{MUP::STUB_OF_GEN32} \\
\verb|unsigned mup::| & \verb|indirect_of ( min::gen32 v )|
\label{MUP::INDIRECT_OF_GEN32} \\
\end{tabular}\end{center}%
\mupindex{int\_of}%
\mupindex{stub\_of}%
\mupindex{indirect\_of}

New {\tt min::gen32} values can be generated by the following functions:

\begin{center}\begin{tabular}{r@{}l}
\verb|min::gen32 min::| & \verb|new_gen32 ( int v )|
\label{MIN::NEW_GEN32_OF_INT} \\
\verb|min::gen32 min::| & \verb|new_gen32 ( min::stub * s )|
\label{MIN::NEW_GEN32_OF_STUB} \\
\verb|min::gen32 min::| & \verb|new_gen32 ( unsigned p )|
\label{MIN::NEW_GEN32_OF_INDIRECT} \\
\end{tabular}\end{center}%
\minindex{new\_gen32}

Here an \verb|unsigned| value is taken to be an indirect pointer.

TBD: range errors and mup counterparts.

\subsubsection{64-Bit General Values}
\label{64-BIT-GENERAL-VALUES}

A \key{64-bit general value} has type \minkey{gen64} and
is a 64 bit aligned value that can hold a value of one of the following
subtypes

\begin{center}
\begin{tabular}{l}
an IEEE 64-bit floating point number \\
a 0-6 character string \\
a pointer to a stub \\
an indirect pointer \\
\end{tabular}
\end{center}

This is done by using the high order 20 bits of the value as a subtype
code, and using values of this subtype code that would be
IEEE Nan (Not-a-Number) values for character string and pointer
values.

The type of a general value is \minkey{gen64}.  This type has the alignment
properties of {\tt min::uns64}, and in some implementations
is {\tt typedef}'ed to {\tt min::uns64}, and so {\tt min::\EOL gen64}
arguments cannot be used to identify overloaded functions.

The following functions return {\tt 1} if a {\tt min::gen64} datum is of the
indicated subtype and {\tt 0} otherwise:

\begin{center}\begin{tabular}{r@{}l}
\verb|int min::| & \verb|is_float64 ( min::gen64 v )|
\label{MIN::IS_FLOAT64} \\
\verb|int min::| & \verb|is_str ( min::gen64 v )|
\label{MIN::IS_STRING} \\
\verb|int min::| & \verb|is_stub ( min::gen64 v )|
\label{MIN::IS_STUB_OF_GEN64} \\
\verb|int min::| & \verb|is_indirect ( min::gen64 v )|
\label{MIN::IS_INDIRECT_OF_GEN64} \\
\end{tabular}\end{center}%
\minindex{is\_float64}%
\minindex{is\_str}%
\minindex{is\_stub}%
\minindex{is\_indirect}

The following protected functions return the value appropriate for a given
subtype, after checking the subtype code with an {\tt assert} statement:

\begin{center}\begin{tabular}{r@{}l}
\verb|min::float64 min::| & \verb|float64_of ( min::gen64 v )|
\label{MIN::FLOAT64_OF_GEN64} \\
\verb|unsigned min::| & \verb|strlen ( min::gen64 v )|
\label{MIN::STRLEN_OF_GEN64} \\
\verb|char * min::| & \verb|strcpy ( char * p, min::gen64 v )|
\label{MIN::STRCPY_OF_GEN64} \\
\verb|char * min::| & \verb|strncpy ( char * p, min::gen64 v, unsigned n )|
\label{MIN::STRNCPY_OF_GEN64} \\
\verb|min::stub * min::| & \verb|stub_of ( min::gen64 v )|
\label{MIN::STUB_OF_GEN64} \\
\verb|unsigned min::| & \verb|indirect_of ( min::gen64 v )|
\label{MIN::INDIRECT_OF_GEN64} \\
\end{tabular}\end{center}%
\minindex{float64\_of}%
\minindex{strlen}%
\minindex{strcpy}%
\minindex{strncpy}%
\minindex{stub\_of}%
\minindex{indirect\_of}

The {\tt strlen} function returns the length of a string value (which
is from {\tt 0} through {\tt 6}).
The {\tt strcpy} and {\tt strncpy} functions
copy a string value to a buffer pointed at
by \verb|p|.  Copying stops when a NUL is copied or when the
\verb|strncpy| function copies the \verb|n|'th \verb|char|.  The value
of \verb|p| is returned.

The following unprotected functions return the value appropriate for a given
subtype, \underline{without} checking the subtype code:

\begin{center}\begin{tabular}{r@{}l}
\verb|min::float64 mup::| & \verb|float64_of ( min::gen64 v )|
\label{MUP::FLOAT64_OF_GEN64} \\
\verb|min::uns64 mup::| & \verb|short_string_of ( min::gen64 v )|
\label{MUP::SHORT_STRING_OF_GEN64} \\
\verb|min::stub *  mup::| & \verb|stub_of ( min::gen64 v )|
\label{MUP::STUB_OF_GEN64} \\
\verb|unsigned mup::| & \verb|indirect_of ( min::gen64 v )|
\label{MUP::INDIRECT_OF_GEN64} \\
\end{tabular}\end{center}%
\mupindex{float64\_of}%
\mupindex{short\_string\_of}%
\mupindex{stub\_of}%
\mupindex{indirect\_of}

Here the \verb|min::uns64| value returned by \mupkey{short\_string\_of}
should be overlaid by a union with a \verb|char[]| buffer, as in
the code:

\begin{indpar}\label{SHORT-STRING-OVERLAY}\begin{verbatim}
union { min::uns64 str; char buf[8]; } u;
min::gen64 v;
. . . .
u.str = mup::short_string_of ( v );
cout << u.buf;
\end{verbatim}\end{indpar}

The {\tt mup::short\_string\_of} function merely copies the
6 characters from the {\tt min::gen64} value appending 2 NUL characters.

New {\tt min::gen64} values can be generated by the following functions:

\begin{center}\begin{tabular}{r@{}l}
\verb|min::gen64 min::| & \verb|new_gen64 ( min::float64 v )|
\label{MIN::NEW_GEN64_OF_FLOAT64} \\
\verb|min::gen64 min::| & \verb|new_gen64 ( const char * p )|
\label{MIN::NEW_GEN64_OF_CHAR} \\
\verb|min::gen64 min::| & \verb|new_gen64 ( min::stub * s )|
\label{MIN::NEW_GEN64_OF_STUB} \\
\verb|min::gen64 min::| & \verb|new_gen64 ( unsigned p )|
\label{MIN::NEW_GEN64_OF_INDIRECT} \\
\end{tabular}\end{center}%
\minindex{new\_gen64}

Here the NUL-terminated string pointed at by \verb|p| must not
contain more than 6 characters, and an \verb|unsigned| value is
taken to be an indirect pointer.

TBD: range errors and mup counterparts.

The subtype codes used for {\tt min::gen64} string and stub pointer
values are chosen so they are not normally generated by the compiler,
run-time system, or program execution.  Therefore a {\tt min::float64}
input to {\tt min::new\_gen64} is assumed to not have these subtype
codes, and no check is made for such.

The actual string and stub pointer {\tt min::gen64} subtype codes
are implementation dependent.  The following constants equal these
codes as 20 bit unsigned integers:

\begin{center}\begin{tabular}{r@{}l}
\verb|unsigned min::| & \verb|GEN64_STRING|
\label{MIN::GEN64_STRING} \\
\verb|unsigned min::| & \verb|GEN64_STUB|
\label{MIN::GEN64_STUB} \\
\verb|unsigned min::| & \verb|GEN64_INDIRECT|
\label{MIN::GEN64_INDIRECT} \\
\end{tabular}\end{center}%
\minindex{GEN64\_STRING}%
\minindex{GEN64\_STUB}%
\minindex{GEN64\_INDIRECT}

The following functions may be used to retrieve the subtype code field
from a {\tt min::\EOL gen64}, {\tt min::float64}, or
{\tt min::uns64} value:

\begin{center}\begin{tabular}{r@{}l}
\verb|int min::| & \verb|gen64_subtype_of ( min::gen64 v )|
\label{MIN::GEN64_SUBTYPE_OF_GEN64} \\
\verb|int min::| & \verb|gen64_subtype_of ( min::float64 v )|
\label{MIN::GEN64_SUBTYPE_OF_FLOAT64} \\
\verb|int min::| & \verb|gen64_subtype_of ( min::uns64 v )|
\label{MIN::GEN64_SUBTYPE_OF_UNS64} \\
\end{tabular}\end{center}%
\minindex{gen\_64\_subtype\_of}

\subsection{Body Pointers}
\label{BODY-POINTERS}

Body pointers are relocatable and require special programming to
ensure that thay are up-to-date.  This programming makes use of
the `\key{relocated flag}' which is one of the execution flags
described in~\secref{EXECUTION-FLAGS}.

Relocation can only happen inside a MIN system function.  When it
happens, the MIN system function sets the relocated flag.

Upon return from any function call, a function that uses pointers
into bodies stored in local variables must check the relocated flag,
and, if that flag is on, must:

\begin{center}
\begin{tabular}{l}
recompute all local variables containing pointers into bodies \\
clear the relocated flag \\
remember it has cleared the relocated flag
\end{tabular}
\end{center}

When the function returns to its caller, it must set the relocated flag
if that flag was ever cleared by the function.

Pointers into bodies are recomputed from body pointers stored in stubs,
which are updated by MIN system functions that relocate bodies.

The operation of \ikey{deallocating a body}{dealocate!body}
is considered to be a relocation of the body.  The body pointer in the
stub is pointed at unimplemented virtual memory, and the type code in the stub
is set to an illegal value (e.g. zero).  Using a deallocated body is
considered to be a fatal programming error, so usually code need not
check for this case, and crashes when it tries to access the unimplemented
virtual memory.  However, there is a limit to the size of unimplemented
memory, so code using very large bodies should always recheck the type
code when reloading a possibly relocated body pointer.  Also, using an
explicit type code recheck can be a valuable tool for debugging
accesses to deallocated bodies.

Because of all the special handling required by body pointers, functions
that obtain body pointers from stubs are unprotected.

\subsection{Stub Control}
\label{STUB-CONTROL}

A stub contains an 8 byte value and an 8 byte \mkey{control}{of stub}.
If the control is viewed as a 64 bit integer, its high order byte
is the type code.  The high order bit of this, which is the high order
bit of the 64 bit control integer, is off if the stub is managed by
the garbage collector, and on otherwise.  In the former case the
stub is said to be `\key{collectible}'.  In the latter case it is
said to be `\key{uncollectible}'.

If the stub is collectible, so it is managed by the garbage collector,
the control is used exclusively by the garbage collector,
except for the type code, which is shared between the garbage collector
and the rest of the system.  A typical (but not required)
garbage collector organization of the control of a collectible stub is:

\begin{center}
\begin{tabular}{ll}
high order 8 bits:	& type code \\
next 8 bits:		& gc flags \\
low order 48 bits:	& chain pointer \\
\end{tabular}
\end{center}

The chain pointer is used to build lists of allocated stubs which
the garbage collector (gc) manages.

If a stub is uncollectible, its control can be organized in different
ways according to the type code value.  The standard way of organizing
the control is:

\begin{center}
\begin{tabular}{ll}
high order 8 bits:	& type code \\
next 8 bits:		& subtype code \\
low order 48 bits:	& chain pointer \\
\end{tabular}
\end{center}

The main use of non-collectible stubs is as auxilaries.
An `\key{auxilary}' is a non-collectible stub attached to an object.
When the object is garbage collected, the auxilary is freed.  Auxilaries
are a means of adding memory to an object without relocating the object.
For example, if the object stores 64-bit IEEE floating point numbers,
an auxilary can be used to add memory for an additional number to the
object.  Note the auxilary stub itself typically does not contain enough
information to tell the type of the value it stores: generally one must
trace the reference from the object pointing at the auxilary
to determine this type.

\subsection{Stub Type Codes}
\label{STUB-TYPE-CODES}

The type code of a stub may be returned by

\begin{center}
\verb|int type_of ( min::stub * s )|
\end{center}%
\label{TYPE_OF}\ttindex{type\_of}

A determination of whether or not a stub is collectible may be made
by applying the function

\begin{center}
\verb|bool min::is_collectible ( int type )|
\end{center}%
\label{MIN::IS_COLLECTIBLE}\minindex{is\_collectible}

to the type code of the stub.  Notice that type codes are signed integers, so
that negative type codes are uncollectible and positive type codes
are collectible.

A partial list of stub type codes is:

\begin{center}
\begin{tabular}{l@{~~~~~}p{4in}}
\tt min::NUMBER	&	Stub value is an IEEE 64-bit floating point number.
\\
\tt min::SHORT\_STRING
	&	Stub value is 0-8 \verb|const char| string, 0 padded.
\\
\tt min::LONG\_STRING
	&	Stub value is a pointer at a body of type
	        {\tt min::long\_\EOL string} that contains a
		\verb|const char| vector and its size. 
\end{tabular}
\end{center}

A full list of stub type codes complete with page references
is given on \pagref{STUB-TYPE-CODE-LIST}.

\subsection{Stub Values}
\label{STUB-VALUES}

A stub contains a 64-bit value whose type depends upon the stub
type code (\secref{STUB-TYPE-CODES}).  Many stubs are immutable
and their values cannot be written after the stub has been created;
nevertheless we describe unprotected functions below that
write these values.  Unprotected functions are also provided to obtain
body pointers from stubs when these are the values of the stubs.
This cannot be done by protected
functions as body pointers are relocatable and require special
programming be sure they are up-to-date (\secref{BODY-POINTERS}).

\subsection{Number Stubs}
\label{NUMBER-STUBS}

A \key{number stub} has \minkey{NUMBER}\label{NUMBER-TYPE} type code and
an immutable \verb|min::float64| value that can be read by

\begin{center}\begin{tabular}{r@{}l}
\verb|min::float64 | & \verb|float64_of ( min::stub * s )|
\label{FLOAT64_OF} \\
\verb|min::float64 mup::| & \verb|float64_of ( min::stub * s )|
\label{MUP::FLOAT64_OF}
\end{tabular}\end{center}%
\ttkey{float64\_of}%
\mupkey{float64\_of}

and written by

\begin{center}\begin{tabular}{r@{}l}
\verb|void mup::| & \verb|set_float64_of ( min::stub * s, min::float64 f )|
\label{MUP::SET_FLOAT64_OF}
\end{tabular}\end{center}%
\mupkey{set\_float64\_of}


\subsection{String Stubs}
\label{STRING-STUBS}

In MIN all \verb|char| \skey{string}s\index{char strings@{\tt char} strings}
are NUL terminated UTF-8 encoded UNICODE character strings.
UTF-8 encodes 16 bit UNICODE characters in 1, 2, or 3 \verb|char| characters,
and encodes certain pairs of two 16 bit UNICODE characters
(call surrogates) in 4 \verb|char| characters.

All ASCII characters are encoded by themselves in
the UTF-8 encoding.  This implies that
all ASCII character strings are UTF-8 encoded character
strings with the same characters as their ASCII representation indicates.

It is possible for a \verb|char| string to be miscoded UTF-8.  None
of the functions given below, including the protected functions,
check for this.

There are two kinds of string stubs: short strings and long strings.
There are no protected functions directly accessing these.  There are
protected functions accessing strings of either type without distinction,
and these are described toward the end of this section, after describing
short and long strings and their unprotected access functions.

A \key{short string stub} has
\minkey{SHORT\_STRING}\label{SHORT-STRING-TYPE} type code and
an immutable \verb|min::uns64| value that holds NUL padded
8 \verb|char| vector and can be read by


\begin{center}\begin{tabular}{r@{}l}
\verb|min::uns64 mup::| & \verb|short_string_of ( min::stub * s )|
\label{MUP::SHORT_STRING_OF}
\end{tabular}\end{center}%
\mupkey{short\_string\_of}

and written by

\begin{center}\begin{tabular}{r@{}l}
\verb|void mup::| & \verb|set_short_string_of ( min::stub * s, min::uns64 str )|
\label{MUP::SET_SHORT_STRING_OF}
\end{tabular}\end{center}%
\mupkey{set\_short\_string\_of}

Here the \verb|min::uns64| value returned by \mupkey{short\_string\_of}
should be overlaid by a union with a \verb|char[]| buffer, as in

\begin{indpar}\begin{verbatim}
union { min::uns64 str; char buf[9]; } u;
min::stub * s1, * s2;
. . . .
u.buf[8] = 0;	// Be sure result is NUL terminated.
u.str = mup::short_string_of ( s1 );
cout << u.buf;
. . . .
u.str = 0;	// Be sure all 8 bytes are NUL padded.
cin >> u.buf;
mup::set_short_string_of ( s2 , u.str );
\end{verbatim}\end{indpar}

Short string values are NUL (zero) padded 0 to 8 \verb|char|
strings.  To be sure any value read is NUL terminated, a NUL (zero)
must be stored after the value read, as is done by \verb|u.buf[8] = 0|
in the example.  If the value read is not what it should be, it
may have non-NUL characters after a NUL character, but with
the 9'th NUL appended it will still be a NUL-terminated C/C++ \verb|char|
string.

A \key{long string stub} has
\minkey{LONG\_STRING}\label{LONG-STRING-TYPE} type code and
a value that is a pointer to a \minkey{long\_string} type body
which holds an arbitrary length NUL terminated \verb|char| string.
The following functions respectively return a movable pointer to this body,
the length of the string, a 32-bit non-zero hash value computed from
the string, a 64-bit signature for the string,
and a movable pointer to the string.  If the hash value
has not been previously accessed, it is computed and saved in the
string by the function that returns it, causing that function to
take time proportional to the string length.  The 64-bit signature
contains the hash value and the string length.

\begin{center}\begin{tabular}{r@{}l}
\verb|min::long_string * mup::| & \verb|long_string_of ( min::stub * s )|
\label{MUP::LONG_STRING_OF} \\
\verb|unsigned | & \verb|length_of ( min::long_string * str )|
\label{LENGTH_OF_LONG_STRING} \\
\verb|unsigned | & \verb|hash_of ( min::long_string * str )|
\label{HASH_OF_LONG_STRING} \\
\verb|min::uns64 | & \verb|signature_of ( min::long_string * str )|
\label{SIGNATURE_OF_LONG_STRING} \\
\verb|const char * | & \verb|char_of ( min::long_string * str )|
\label{CHAR_OF_LONG_STRING}
\end{tabular}\end{center}%
\mupkey{long\_string\_of}%
\ttkey{length\_of}%
\ttkey{hash\_of}%
\ttkey{signature\_of}%
\ttkey{char\_of}

The long string body consists of a 64 bit signature containing
the 32-bit length and 32-bit hash value, followed by a \verb|char|
vector containing the string with the terminating NUL.  The
\verb|char| vector is padded to a multiple of 8 bytes with NUL
bytes, but the terminating NUL and the padding are not included
in the length.  If the hash has not been computed, it is
stored in the header as zero.  Unprotected versions of the above
functions return the same values with the following exceptions:
an uncomputed hash is returned as zero, and the movable pointer
to the string permits the string to be written.  Unprotected functions
are also provided to set the length and hash.

\begin{center}\begin{tabular}{r@{}l}
\verb|unsigned mup::| & \verb|hash_of ( min::long_string * str )|
\label{MUP::HASH_OF_LONG_STRING} \\
\verb|char * mup::| & \verb|char_of ( min::long_string * str )|
\label{MUP::CHAR_OF_LONG_STRING} \\
\verb|void mup::| &
   \verb|set_length_of ( min::long_string * str, unsigned length )|
\label{MUP::SET_LENGTH_OF_LONG_STRING} \\
\verb|void mup::| &
   \verb|set_hash_of ( min::long_string * str, unsigned hash )|
\label{MUP::SET_HASH_OF_LONG_STRING}
\end{tabular}\end{center}%
\mupkey{hash\_of}%
\mupkey{char\_of}%
\mupkey{set\_length\_of}%
\mupkey{set\_hash\_of}

The following are protected functions that operate on both stort and long
strings.  These functions have the same (overloaded) names and are analogous
to standard C library string functions.

The functions

\begin{center}\begin{tabular}{r@{}l}
\verb|unsigned | & \verb|strlen ( min::stub * s )|
\label{STRLEN} \\
\verb|unsigned | & \verb|strhash ( min::stub * s )|
\label{STRHASH} \\
\verb|min::uns64 | & \verb|strsignature ( min::stub * s )|
\label{STRSIGNATURE}
\end{tabular}\end{center}%
\ttkey{strlen}%
\ttkey{strhash}%
\ttkey{strsignature}

return the length of the string (excluding the terminating NUL),
the hash value of the string, and the signature of the string.
The low order bits of the hash value are random, so it can be
truncated to provide a random hash.  The signatures of two strings
are equal if the strings are equal, but there is a small chance
the signatures of unequal strings will be equal.\footnote{The chance
is much greater for the signature used by MIN than it would be
for an MD5 signature, which has the same length but is much slower
to compute.}

The functions

\begin{center}\begin{tabular}{r@{}l}
\verb|char * | & \verb|strcpy ( char * p, min::stub * s )|
\label{STRCPY} \\
\verb|char * | & \verb|strncpy ( char * p, min::stub * s, unsigned n )|
\label{STRNCPY}
\end{tabular}\end{center}%
\ttkey{strcpy}%
\ttkey{strncpy}

copy a string from a MIN short or long string to a buffer pointed at
by \verb|p|.  Copying stops when a NUL is copied or when the
\verb|strncpy| function copies the \verb|n|'th \verb|char|.  The value
of \verb|p| is returned.

\subsection{Double Arrows}

An example use of an auxilary to add memory to an object is in the
representation of double arrows.  The problem is that interally
a double arrow value must both point at the object that is the
arrow target and must also point at the label used by the target to
a double arrow value.  E.g, given

\begin{indpar}\begin{verbatim}
##1::
    fee: ##2 :fie

##2::
    fie: ##1 :fee
\end{verbatim}\end{indpar}

in which \verb|##1| and \verb|##2| are connected by a double
arrow that has the \verb|##1| attribute name \verb|fee| 
and the \verb|##2| attribute name \verb|fie|, then object \verb|##1|
must store as its \verb|fee| attribute value \underline{both}
the pointer to \verb|##2| that is the proper value of the attribute
\underline{and} the label \verb|fie| used by \verb|##2| to reference
the arrow in the other direction.  This is so that if the value of
the \verb|fee| attribute of \verb|##1| is changed, the \verb|fie|
attribute of \verb|##2| can be located and deleted.

The mechanism used to store the double pointer is:

\begin{indpar}\begin{verbatim}
 +---------------------------------------------------------+
 v                                                         |
##1::                                                      |
    fee: ---> auxilary 1:                                  |
 +------------- value = ##2                                |
 |              chain pointer ---> auxilary 2:             |
 |                                   value = fie           |
 |                                   chain pointer = NULL  |
 v                                                         |
##2::                                                      |
    fie: ---> auxilary 3:                                  |
                value = ##1 -------------------------------+
                chain pointer ---> auxilary 3:
                                     value = fee
                                     chain pointer = NULL
\end{verbatim}\end{indpar}

\clearpage

\subsection{Objects}

An object has a body that consists of 5 parts:

\begin{center}
\begin{tabular}{l}
header \\
hash table \\
list \\
unused \\
auxilary
\end{tabular}
\end{center}

The header contains the sizes of the other 4 parts.  The hash table
stores attribute label/value pairs, for attributes whose labels that are not
small integers.  The list stores attribute values, for attributes whose
labels are small integers.  The auxilary area stores various overflow
data from the hash table and list areas.

The hash table is of fixed size; its size can only be changed by relocating
the object body.  The list grows up from the hash table into the unused
area, and the auxilary storage grows down from the end of the body into
the unused area.

\subsubsection{Indirect Pointers}
\label{INDIRECT-POINTERS}

\section{Code and Execution}

\subsection{Execution Flags}
\label{EXECUTION-FLAGS}

\appendix

\centerline{\Large \bf Appendices}

\section{C/C++ Interface}
\label{C/C++-Interface}

The declarations here differ from legal C/C++ code in that
we write

\begin{indpar}\begin{verbatim}
struct min::stub;
bool min::is_collectible ( int type );
\end{verbatim}\end{indpar}

which is not legal C or C++ when what we mean is

\begin{indpar}\begin{verbatim}
struct min
{
    struct stub;
    bool is_collectible ( int type );
};
\end{verbatim}\end{indpar}

\newcommand{\REF}[1]{\dotfill~\pagref{#1}}

Data Declarations:

\begin{indpar}[0.2in]

\verb|struct min::stub| \REF{MIN::STUB}

\end{indpar}

Stub Type Codes:\label{STUB-TYPE-CODE-LIST}

\begin{indpar}[0.2in]

\verb|min::NUMBER| \REF{NUMBER-TYPE}
\\
\verb|min::SHORT_STRING| \REF{SHORT-STRING-TYPE}
\\
\verb|min::LONG_STRING| \REF{LONG-STRING-TYPE}

\end{indpar}

Stub Data Function Declarations:

\begin{indpar}[0.2in]

\begin{tabular}{@{}r@{}p{4.5in}}

\verb|int | & \verb|type_of ( min::stub * s )| \REF{TYPE_OF}
\\
\verb|bool min::| & \verb|is_collectible ( int type )| \REF{MIN::IS_COLLECTIBLE}
\\
\verb|min::float64 | & \verb|float64_of ( min::stub * s )|
\REF{FLOAT64_OF}
\\
\verb|min::float64 mup::| & \verb|float64_of ( min::stub * s )|
\REF{MUP::FLOAT64_OF}
\\
\verb|void mup::| & \verb|set_float64_of ( min::stub * s, min::float64 f )|
\REF{MUP::SET_FLOAT64_OF}
\\
\verb|min::uns64 | & \verb|mup::short_string_of ( min::stub * s )|
\REF{MUP::SHORT_STRING_OF}
\\
\verb|void mup::| & \verb|set_short_string_of| \\
                  & \verb|  ( min::stub * s, min::uns64 str )|
\REF{MUP::SET_SHORT_STRING_OF}
\\
\verb|min::long_string  | \\
\verb|  * mup::| & \verb|long_string_of ( min::stub * s )|
\REF{MUP::LONG_STRING_OF}
\\
\verb|unsigned | & \verb|length_of ( min::long_string * str )|
\REF{LENGTH_OF_LONG_STRING}
\\
\verb|unsigned | & \verb|hash_of ( min::long_string * str )|
\REF{HASH_OF_LONG_STRING}
\\
\verb|min::uns64 | & \verb|signature_of ( min::long_string * str )|
\REF{SIGNATURE_OF_LONG_STRING}
\\
\verb|const char * | & \verb|char_of ( min::long_string * str )|
\REF{CHAR_OF_LONG_STRING}
\\
\verb|unsigned mup::| & \verb|hash_of ( min::long_string * str )|
\REF{MUP::HASH_OF_LONG_STRING}
\\
\verb|char * mup::| & \verb|char_of ( min::long_string * str )|
\REF{MUP::CHAR_OF_LONG_STRING}
\\
\verb|void mup::| & \verb|set_length_of| \\
                  & \verb|  ( min::long_string * str, unsigned length )|
\REF{MUP::SET_LENGTH_OF_LONG_STRING}
\\
\verb|void mup::| & \verb|set_hash_of| \\
                  & \verb|  ( min::long_string * str, unsigned hash )|
\REF{MUP::SET_HASH_OF_LONG_STRING}

\end{tabular}


\end{indpar}

\bibliographystyle{plain}
\bibliography{min}

\printindex

\end{document}



